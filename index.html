<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Turbo Headshots</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
      padding-top: 50px;
    }
    
    .container { max-width: 900px; margin: 0 auto; }
    
    header { text-align: center; margin-bottom: 30px; }
    header .logo { height: 60px; margin-bottom: 10px; }
    header h1 { font-size: 1.8em; font-weight: 400; margin-bottom: 5px; color: #fff; }
    header p { color: #a0a0a0; font-size: 0.9em; }
    header .processing-indicator { display: inline-flex; margin-top: 15px; }
    
    .status-bar {
      display: flex; gap: 20px; margin-bottom: 30px; padding: 15px;
      background: rgba(255,255,255,0.05); border-radius: 12px;
    }
    
    .status-item {
      flex: 1; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s;
    }
    .status-item:hover { background: rgba(255,255,255,0.1); }
    .status-item label { font-size: 0.8em; color: #888; display: block; margin-bottom: 5px; }
    .status-item .value { font-size: 0.9em; word-break: break-all; }
    .status-item .value.not-set { color: #ff6b6b; }
    .status-item .value.set { color: #51cf66; }
    
    .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
    
    .card { background: rgba(255,255,255,0.08); border-radius: 16px; padding: 25px; }
    .card h2 { font-size: 1.2em; font-weight: 500; margin-bottom: 20px; color: #ccc; }
    
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 0.85em; color: #aaa; margin-bottom: 8px; }
    .form-group input {
      width: 100%; padding: 12px 15px; border: 2px solid rgba(255,255,255,0.1);
      border-radius: 10px; background: rgba(0,0,0,0.3); color: #fff; font-size: 1em; transition: border-color 0.2s;
    }
    .form-group input:focus { outline: none; border-color: #c83232; }
    .form-group input::placeholder { color: #666; }
    
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 14px 28px; border: none; border-radius: 10px; font-size: 1em;
      font-weight: 500; cursor: pointer; transition: all 0.2s; width: 100%;
    }
    .btn-primary { background: linear-gradient(135deg, #c83232 0%, #a02828 100%); color: #fff; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(200, 50, 50, 0.3); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-success { background: linear-gradient(135deg, #51cf66 0%, #40c057 100%); color: #fff; }
    .btn-success:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(81, 207, 102, 0.3); }
    
    .preview-area {
      height: 300px; background: rgba(0,0,0,0.3); border-radius: 12px;
      display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
    }
    .preview-area img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .preview-area .placeholder { text-align: center; color: #666; }
    .preview-area .placeholder .icon { font-size: 3em; margin-bottom: 15px; opacity: 0.5; }
    
    .toast {
      position: fixed; bottom: 30px; right: 30px; padding: 15px 25px;
      background: #51cf66; color: #fff; border-radius: 10px; font-weight: 500;
      transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 1000;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.error { background: #ff6b6b; }
    
    .recent-sessions { margin-top: 30px; }
    .recent-sessions h3 { font-size: 1.1em; margin-bottom: 15px; color: #aaa; }
    
    .session-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px; cursor: pointer;
    }
    .session-item:hover { background: rgba(255,255,255,0.1); }
    .session-item .name { font-weight: 500; }
    .session-item .email { font-size: 0.85em; color: #888; }
    .session-item .count { background: rgba(200, 50, 50, 0.2); color: #e85555; padding: 4px 10px; border-radius: 20px; font-size: 0.8em; }
    
    .empty-state { text-align: center; padding: 40px; color: #666; }
    
    .photo-counter {
      text-align: center; margin-top: 15px; padding: 15px;
      background: rgba(81, 207, 102, 0.2); border-radius: 8px; color: #51cf66;
      font-size: 1.2em; font-weight: 500;
    }
    
    .active-session {
      background: rgba(81, 207, 102, 0.1); border: 2px solid rgba(81, 207, 102, 0.3);
      border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: center;
    }
    .active-session .name { font-size: 1.3em; font-weight: 600; color: #51cf66; }
    .active-session .status { font-size: 0.9em; color: #aaa; margin-top: 5px; }
    
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .recording { animation: pulse 1.5s ease-in-out infinite; }

    /* Update Banner */
    .update-banner {
      position: fixed; top: 0; left: 0; right: 0; z-index: 2000;
      background: linear-gradient(135deg, #4a69bd 0%, #6a89cc 100%);
      padding: 12px 20px; display: none; align-items: center; justify-content: center; gap: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .update-banner.show { display: flex; }
    .update-banner .message { font-size: 0.95em; font-weight: 500; }
    .update-banner .version { background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 0.85em; }
    .update-banner .btn-update {
      background: #fff; color: #4a69bd; border: none; padding: 8px 18px;
      border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9em; transition: all 0.2s;
    }
    .update-banner .btn-update:hover { transform: scale(1.05); }
    .update-banner .btn-dismiss {
      background: transparent; border: 1px solid rgba(255,255,255,0.4); color: #fff;
      padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85em;
    }
    .update-banner .btn-dismiss:hover { background: rgba(255,255,255,0.1); }
    .update-banner .progress-bar {
      width: 200px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden;
    }
    .update-banner .progress-bar .fill {
      height: 100%; background: #fff; transition: width 0.3s; width: 0%;
    }
    .version-display { position: fixed; bottom: 10px; right: 15px; font-size: 0.75em; color: #555; }

    /* AI Processing Status */
    .processing-indicator {
      display: flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,0.08); padding: 8px 15px;
      border-radius: 20px; font-size: 0.85em; cursor: pointer;
      transition: background 0.2s;
    }
    .processing-indicator:hover { background: rgba(255,255,255,0.12); }
    .processing-indicator .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #666;
    }
    .processing-indicator .dot.active { background: #51cf66; animation: pulse 1.5s ease-in-out infinite; }
    .processing-indicator .dot.warning { background: #fcc419; }
    .processing-indicator .dot.error { background: #ff6b6b; }
    .processing-indicator .dot.disabled { background: #666; }

    /* Settings Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 3000;
      display: none; align-items: center; justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #1a1a2e; border-radius: 16px; padding: 30px;
      width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .modal h2 { margin-bottom: 20px; font-weight: 500; }
    .modal .form-group { margin-bottom: 20px; }
    .modal .form-group label { display: block; font-size: 0.85em; color: #aaa; margin-bottom: 8px; }
    .modal .form-group input[type="text"],
    .modal .form-group input[type="password"] {
      width: 100%; padding: 12px 15px; border: 2px solid rgba(255,255,255,0.1);
      border-radius: 10px; background: rgba(0,0,0,0.3); color: #fff; font-size: 1em;
    }
    .modal .form-group input:focus { outline: none; border-color: #c83232; }
    .modal-actions { display: flex; gap: 10px; margin-top: 25px; }
    .modal-actions .btn { flex: 1; }
    .btn-secondary {
      background: rgba(255,255,255,0.1); color: #fff; border: none;
      padding: 12px 20px; border-radius: 10px; cursor: pointer; font-size: 1em;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }

    /* Toggle Switch */
    .toggle-group { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .toggle-group label { font-size: 0.9em; color: #ccc; }
    .toggle-switch {
      position: relative; width: 50px; height: 26px;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.1); border-radius: 26px; transition: 0.3s;
    }
    .toggle-slider:before {
      position: absolute; content: ""; height: 20px; width: 20px;
      left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider { background: #51cf66; }
    .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }

    /* Status message */
    .status-message { padding: 10px 15px; border-radius: 8px; margin-top: 15px; font-size: 0.9em; }
    .status-message.success { background: rgba(81, 207, 102, 0.2); color: #51cf66; }
    .status-message.error { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
    .status-message.info { background: rgba(74, 105, 189, 0.2); color: #6a89cc; }

    /* Processing Queue Panel */
    .queue-panel {
      background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; margin-top: 20px;
    }
    .queue-panel h3 { font-size: 1em; margin-bottom: 15px; color: #aaa; display: flex; align-items: center; gap: 8px; }
    .queue-stats { display: flex; gap: 15px; flex-wrap: wrap; }
    .queue-stat {
      background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 8px; text-align: center; min-width: 80px;
    }
    .queue-stat .value { font-size: 1.5em; font-weight: 600; color: #fff; }
    .queue-stat .label { font-size: 0.75em; color: #888; margin-top: 3px; }
    .queue-stat.pending .value { color: #fcc419; }
    .queue-stat.processing .value { color: #51cf66; }
    .queue-stat.failed .value { color: #ff6b6b; }
    .queue-stat.completed .value { color: #51cf66; }

    .queue-actions { margin-top: 15px; display: flex; gap: 10px; }
    .btn-small {
      padding: 8px 15px; font-size: 0.85em; border: none; border-radius: 6px; cursor: pointer;
      background: rgba(255,255,255,0.1); color: #fff; transition: background 0.2s;
    }
    .btn-small:hover { background: rgba(255,255,255,0.2); }
    .btn-small:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Cost estimate */
    .cost-estimate { margin-top: 15px; padding: 10px 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.85em; color: #888; }

    /* Highlight button */
    .btn-small.btn-highlight { background: rgba(200, 50, 50, 0.3); border: 1px solid rgba(200, 50, 50, 0.5); }
    .btn-small.btn-highlight:hover { background: rgba(200, 50, 50, 0.5); }

    /* Warning/Stop button */
    .btn-small.btn-warning { background: rgba(252, 196, 25, 0.3); border: 1px solid rgba(252, 196, 25, 0.5); color: #fcc419; }
    .btn-small.btn-warning:hover { background: rgba(252, 196, 25, 0.4); }
    .btn-small.btn-warning:disabled { opacity: 0.4; color: #888; }

    /* Session folder list */
    .session-folder-list { max-height: 400px; overflow-y: auto; margin-bottom: 15px; }
    .session-folder-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 15px; background: rgba(255,255,255,0.05); border-radius: 8px;
      margin-bottom: 8px; cursor: pointer; transition: background 0.2s;
    }
    .session-folder-item:hover { background: rgba(255,255,255,0.1); }
    .session-folder-item .info { flex: 1; }
    .session-folder-item .name { font-weight: 500; margin-bottom: 3px; }
    .session-folder-item .details { font-size: 0.8em; color: #888; }
    .session-folder-item .status-badge {
      padding: 4px 10px; border-radius: 12px; font-size: 0.75em; font-weight: 500;
    }
    .session-folder-item .status-badge.needs-processing { background: rgba(252, 196, 25, 0.2); color: #fcc419; }
    .session-folder-item .status-badge.processed { background: rgba(81, 207, 102, 0.2); color: #51cf66; }
    .session-folder-item .btn-reprocess {
      padding: 6px 12px; background: rgba(200, 50, 50, 0.3); border: none;
      border-radius: 6px; color: #fff; font-size: 0.8em; cursor: pointer; margin-left: 10px;
    }
    .session-folder-item .btn-reprocess:hover { background: rgba(200, 50, 50, 0.5); }
    .session-folder-item .btn-reprocess:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Failed items list */
    .failed-item {
      background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; font-size: 0.85em;
    }
    .failed-item .name { font-weight: 500; color: #fff; margin-bottom: 4px; }
    .failed-item .error { color: #ff6b6b; word-break: break-word; }

    /* Enhancement select dropdowns */
    .enhancement-group {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px; padding: 8px 0;
    }
    .enhancement-group label {
      font-size: 0.9em; color: #ccc; flex: 1;
    }
    .enhancement-select {
      width: 120px; padding: 8px 12px; border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff;
      font-size: 0.9em; cursor: pointer; appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 10px center;
    }
    .enhancement-select:focus { outline: none; border-color: #c83232; }
    .enhancement-select option { background: #1a1a2e; color: #fff; }

    /* Color input */
    .color-input-group {
      display: flex; align-items: center; gap: 10px;
    }
    .color-input {
      width: 40px; height: 32px; border: none; border-radius: 6px;
      cursor: pointer; background: transparent;
    }
    .color-text {
      width: 90px; padding: 8px; border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px; background: rgba(0,0,0,0.3); color: #fff; font-size: 0.9em;
    }
    .color-text:focus { outline: none; border-color: #c83232; }

    /* Section divider */
    .settings-section {
      margin: 20px 0 15px 0; font-size: 1em; color: #aaa;
      border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;
    }

    /* Processing Log */
    .processing-log {
      background: rgba(0,0,0,0.4); border-radius: 8px; padding: 10px;
      font-family: 'Monaco', 'Menlo', monospace; font-size: 0.75em;
      max-height: 200px; overflow-y: auto; color: #aaa;
    }
    .processing-log .log-entry {
      padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .processing-log .log-entry:last-child { border-bottom: none; }
    .processing-log .log-time { color: #666; margin-right: 8px; }
    .processing-log .log-info { color: #6a89cc; }
    .processing-log .log-success { color: #51cf66; }
    .processing-log .log-warning { color: #fcc419; }
    .processing-log .log-error { color: #ff6b6b; }
    .processing-log .log-step { color: #c083e0; }

    /* Gallery Modal Styles */
    .gallery-indicator {
      display: flex; align-items: center; gap: 8px; margin-bottom: 15px;
      background: rgba(81, 207, 102, 0.1); border: 1px solid rgba(81, 207, 102, 0.3);
      border-radius: 8px; padding: 10px 15px;
    }
    .gallery-indicator .gallery-name { flex: 1; font-weight: 500; color: #51cf66; }
    .gallery-indicator .btn-clear {
      background: none; border: none; color: #888; cursor: pointer;
      font-size: 1.2em; padding: 0 5px; transition: color 0.2s;
    }
    .gallery-indicator .btn-clear:hover { color: #ff6b6b; }

    .gallery-list { max-height: 300px; overflow-y: auto; margin-bottom: 15px; }
    .gallery-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 15px; background: rgba(255,255,255,0.05); border-radius: 8px;
      margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
      border: 2px solid transparent;
    }
    .gallery-item:hover { background: rgba(255,255,255,0.1); }
    .gallery-item.selected { border-color: #51cf66; background: rgba(81, 207, 102, 0.1); }
    .gallery-item .gallery-info { flex: 1; }
    .gallery-item .gallery-title { font-weight: 500; margin-bottom: 3px; }
    .gallery-item .gallery-meta { font-size: 0.8em; color: #888; }
    .gallery-item .btn-select {
      padding: 6px 12px; background: rgba(200, 50, 50, 0.3); border: none;
      border-radius: 6px; color: #fff; font-size: 0.85em; cursor: pointer;
    }
    .gallery-item .btn-select:hover { background: rgba(200, 50, 50, 0.5); }

    .create-gallery-form { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
    .create-gallery-form .form-row { display: flex; gap: 10px; align-items: flex-end; }
    .create-gallery-form .form-row .form-group { flex: 1; margin-bottom: 0; }
    .create-gallery-form .form-row .btn { width: auto; padding: 12px 20px; }

    .upload-options { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
    .upload-options h4 { font-size: 0.9em; color: #aaa; margin-bottom: 10px; }

    .login-section { margin-bottom: 20px; }
    .login-section.hidden { display: none; }
    .auth-status {
      display: flex; align-items: center; gap: 10px; padding: 10px 15px;
      background: rgba(81, 207, 102, 0.1); border-radius: 8px; margin-bottom: 15px;
    }
    .auth-status .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #51cf66; }
    .auth-status .status-text { flex: 1; color: #51cf66; }
    .auth-status .btn-logout {
      padding: 4px 10px; background: rgba(255,255,255,0.1); border: none;
      border-radius: 4px; color: #aaa; font-size: 0.8em; cursor: pointer;
    }
    .auth-status .btn-logout:hover { background: rgba(255,255,255,0.2); }

    .upload-stats { display: flex; gap: 10px; margin-top: 10px; }
    .upload-stat {
      flex: 1; text-align: center; padding: 8px; background: rgba(0,0,0,0.2);
      border-radius: 6px; font-size: 0.8em;
    }
    .upload-stat .value { font-size: 1.2em; font-weight: 600; }
    .upload-stat.success .value { color: #51cf66; }
    .upload-stat.failed .value { color: #ff6b6b; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="logo.png" alt="Turbo 360" class="logo">
      <h1>Turbo Headshots</h1>
      <p>Register details, then take photos with LUMIX Tether</p>
      <div class="processing-indicator" id="processingIndicator" onclick="openSettingsModal()">
        <span class="dot" id="processingDot"></span>
        <span id="processingText">AI Processing: Setup Required</span>
      </div>
    </header>
    
    <div class="status-bar">
      <div class="status-item" onclick="selectWatchFolder()">
        <label>Watch Folder (LUMIX Tether Output)</label>
        <div class="value" id="watchFolderStatus">Click to set...</div>
      </div>
      <div class="status-item" onclick="selectOutputFolder()">
        <label>Output Folder (Organized Headshots)</label>
        <div class="value" id="outputFolderStatus">Click to set...</div>
      </div>
    </div>
    
    <div class="main-content">
      <!-- Registration Form -->
      <div class="card">
        <h2>Registration</h2>
        
        <!-- Active Session Display -->
        <div class="active-session" id="activeSession" style="display: none;">
          <div class="name" id="activeSessionName"></div>
          <div class="status recording">Session Active - Take photos now</div>
        </div>
        
        <div id="formFields">
          <div class="form-group">
            <label>First Name *</label>
            <input type="text" id="firstName" placeholder="John" autofocus>
          </div>
          
          <div class="form-group">
            <label>Last Name *</label>
            <input type="text" id="lastName" placeholder="Smith">
          </div>
          
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="email" placeholder="john@company.com">
          </div>

          <div class="form-group">
            <label>Mobile</label>
            <input type="tel" id="mobile" placeholder="0400 000 000">
          </div>

          <div class="form-group">
            <label>Company</label>
            <input type="text" id="company" placeholder="Acme Inc">
          </div>
        </div>
        
        <button class="btn btn-primary" id="startBtn" onclick="startSession()" disabled>
          Start Session
        </button>
        
        <button class="btn btn-success" id="endBtn" onclick="endSession()" style="display: none;">
          End Session - Next Person
        </button>
        
        <div class="photo-counter" id="photoCounter" style="display: none;">
          <span id="photoCount">0</span> photo(s) saved
        </div>
      </div>
      
      <!-- Preview -->
      <div class="card">
        <h2>Latest Photo</h2>
        
        <div class="preview-area" id="previewArea">
          <div class="placeholder">
            <div class="icon">ðŸ“·</div>
            <p>Waiting for image...</p>
            <p style="font-size: 0.85em; margin-top: 5px;">Take a photo in LUMIX Tether</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Recent Sessions -->
    <div class="recent-sessions">
      <h3>Recent Sessions</h3>
      <div id="recentList">
        <div class="empty-state">No sessions yet today</div>
      </div>
    </div>

    <!-- Processing Queue Panel -->
    <div class="queue-panel" id="queuePanel">
      <h3>AI Enhancement Queue</h3>

      <!-- Gallery Indicator (shown when gallery is selected) -->
      <div id="galleryIndicator" class="gallery-indicator" style="display: none;">
        <span>Uploading to:</span>
        <span class="gallery-name" id="selectedGalleryName">-</span>
        <button class="btn-clear" onclick="clearGallerySelection()" title="Clear selection">&times;</button>
      </div>
      <div class="queue-stats">
        <div class="queue-stat pending">
          <div class="value" id="queuePending">0</div>
          <div class="label">Pending</div>
        </div>
        <div class="queue-stat processing">
          <div class="value" id="queueProcessing">0</div>
          <div class="label">Processing</div>
        </div>
        <div class="queue-stat failed" onclick="toggleFailedDetails()" style="cursor: pointer;">
          <div class="value" id="queueFailed">0</div>
          <div class="label">Failed (click)</div>
        </div>
        <div class="queue-stat completed">
          <div class="value" id="queueCompleted">0</div>
          <div class="label">Completed</div>
        </div>
      </div>
      <div class="queue-actions">
        <button class="btn-small btn-highlight" onclick="openReprocessModal()">Reprocess Existing</button>
        <button class="btn-small" onclick="openGalleryModal()" style="background: rgba(81, 207, 102, 0.3); border: 1px solid rgba(81, 207, 102, 0.5);">Gallery Upload</button>
        <button class="btn-small btn-warning" id="stopProcessingBtn" onclick="stopProcessing()" disabled>Stop</button>
        <button class="btn-small btn-warning" id="clearQueueBtn" onclick="clearQueue()" disabled>Clear Queue</button>
        <button class="btn-small" id="retryFailedBtn" onclick="retryFailed()" disabled>Retry Failed</button>
        <button class="btn-small" id="clearCompletedBtn" onclick="clearCompleted()" disabled>Clear Completed</button>
        <button class="btn-small" onclick="openSettingsModal()">Settings</button>
      </div>
      <div class="cost-estimate" id="costEstimate">
        Estimated cost: ~$0.02 per photo (background removal + face enhancement)
      </div>

      <!-- Failed Items Details -->
      <div id="failedItemsSection" style="display: none; margin-top: 15px;">
        <h4 style="color: #ff6b6b; margin-bottom: 10px;">Failed Items</h4>
        <div id="failedItemsList" style="max-height: 200px; overflow-y: auto;"></div>
      </div>

      <!-- Processing Log -->
      <div class="processing-log-section" style="margin-top: 15px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
          <h4 style="color: #aaa; font-size: 0.9em;">Processing Log</h4>
          <button class="btn-small" onclick="clearProcessingLog()" style="padding: 4px 10px; font-size: 0.75em;">Clear</button>
        </div>
        <div id="processingLog" class="processing-log"></div>
      </div>
    </div>
  </div>
  
  <!-- Reprocess Modal -->
  <div class="modal-overlay" id="reprocessModal">
    <div class="modal" style="max-width: 600px;">
      <h2>Reprocess Existing Sessions</h2>
      <p style="color: #888; margin-bottom: 20px;">Select a session folder to add its photos to the AI enhancement queue.</p>

      <div id="sessionFolderList" class="session-folder-list">
        <div class="empty-state">Loading sessions...</div>
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeReprocessModal()">Close</button>
        <button class="btn-secondary" onclick="selectCustomFolder()">Browse Other Folder...</button>
        <button class="btn btn-primary" id="reprocessAllBtn" onclick="reprocessAllFolders()">Reprocess All</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <h2>AI Enhancement Settings</h2>

      <div class="toggle-group">
        <label>Enable AI Processing</label>
        <label class="toggle-switch">
          <input type="checkbox" id="processingEnabled" onchange="toggleProcessing()">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="toggle-group">
        <label>Auto-process on capture</label>
        <label class="toggle-switch">
          <input type="checkbox" id="autoProcessEnabled" onchange="toggleAutoProcess()">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <h3 class="settings-section">Output Formats</h3>

      <div class="toggle-group">
        <label>Portrait (4:5 aspect ratio)</label>
        <label class="toggle-switch">
          <input type="checkbox" id="outputPortrait" onchange="saveEnhancementOptions()">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="toggle-group">
        <label>Square (1:1 aspect ratio)</label>
        <label class="toggle-switch">
          <input type="checkbox" id="outputSquare" onchange="saveEnhancementOptions()">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <h3 class="settings-section">Enhancement Options</h3>

      <div class="enhancement-group">
        <label>Face Enhancement</label>
        <select id="faceEnhancement" class="enhancement-select" onchange="saveEnhancementOptions()">
          <option value="off">Off</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div>

      <div class="enhancement-group">
        <label>Skin Smoothing</label>
        <select id="skinSmoothing" class="enhancement-select" onchange="saveEnhancementOptions()">
          <option value="off">Off</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div>

      <div class="enhancement-group">
        <label>Shine Removal</label>
        <select id="shineRemoval" class="enhancement-select" onchange="saveEnhancementOptions()">
          <option value="off">Off</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div>

      <div class="enhancement-group">
        <label>Upscaling</label>
        <select id="upscaling" class="enhancement-select" onchange="saveEnhancementOptions()">
          <option value="off">Off</option>
          <option value="2x">2x</option>
          <option value="4x">4x</option>
        </select>
      </div>

      <h3 class="settings-section">Background Options</h3>

      <div class="toggle-group">
        <label>Remove Background (transparent PNG)</label>
        <label class="toggle-switch">
          <input type="checkbox" id="backgroundRemoval" onchange="saveEnhancementOptions()">
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="enhancement-group">
        <label>Background Color (optional)</label>
        <div class="color-input-group">
          <input type="color" id="bgColorPicker" class="color-input" value="#FFFFFF" onchange="updateBgColor()">
          <input type="text" id="backgroundColor" class="color-text" placeholder="#FFFFFF" onchange="saveEnhancementOptions()">
        </div>
      </div>
      <p style="font-size: 0.75em; color: #666; margin-top: -8px; margin-bottom: 15px;">
        Leave empty for transparent. Set color to add solid background.
      </p>

      <h3 style="margin: 20px 0 15px 0; font-size: 1em; color: #aaa; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">API Configuration</h3>

      <div class="form-group">
        <label>Replicate API Key</label>
        <input type="password" id="apiKeyInput" placeholder="r8_xxxxxxxxxxxx">
        <p style="font-size: 0.8em; color: #666; margin-top: 8px;">
          Get your API key from <a href="#" onclick="openExternal('https://replicate.com/account/api-tokens')" style="color: #6a89cc;">replicate.com</a>
        </p>
      </div>

      <div id="connectionStatus"></div>

      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeSettingsModal()">Cancel</button>
        <button class="btn btn-primary" onclick="testAndSaveApiKey()">Test & Save</button>
      </div>
    </div>
  </div>

  <!-- Gallery Modal -->
  <div class="modal-overlay" id="galleryModal">
    <div class="modal" style="max-width: 600px;">
      <h2>Turbo IQ Gallery</h2>

      <!-- Login Section (shown when not authenticated) -->
      <div id="galleryLoginSection" class="login-section">
        <p style="color: #888; margin-bottom: 15px;">Connect to your Turbo IQ Gallery account to auto-upload processed photos.</p>

        <div class="form-group">
          <label>Username</label>
          <input type="text" id="galleryUsername" placeholder="Enter username">
        </div>

        <div class="form-group">
          <label>Password</label>
          <input type="password" id="galleryPassword" placeholder="Enter password">
        </div>

        <div id="galleryLoginStatus"></div>

        <button class="btn btn-primary" onclick="loginToGallery()" style="margin-top: 15px;">
          Connect to Gallery
        </button>
      </div>

      <!-- Authenticated Section (shown when logged in) -->
      <div id="galleryAuthSection" style="display: none;">
        <div class="auth-status">
          <span class="status-dot"></span>
          <span class="status-text">Connected to Turbo IQ Gallery</span>
          <button class="btn-logout" onclick="logoutFromGallery()">Logout</button>
        </div>

        <!-- Gallery Selection -->
        <h3 style="font-size: 1em; color: #aaa; margin-bottom: 10px;">Select Gallery</h3>

        <div id="galleryList" class="gallery-list">
          <div class="empty-state">Loading galleries...</div>
        </div>

        <!-- Create New Gallery -->
        <div class="create-gallery-form">
          <h4 style="font-size: 0.9em; color: #aaa; margin-bottom: 10px;">Create New Gallery</h4>
          <div class="form-row">
            <div class="form-group">
              <input type="text" id="newGalleryName" placeholder="Gallery name (e.g., Corporate Headshots 2024)">
            </div>
            <button class="btn btn-primary" onclick="createNewGallery()">Create</button>
          </div>
        </div>

        <!-- Upload Options -->
        <div class="upload-options">
          <h4>Auto-Upload Options</h4>

          <div class="toggle-group">
            <label>Auto-upload after processing</label>
            <label class="toggle-switch">
              <input type="checkbox" id="galleryAutoUpload" onchange="saveGalleryOptions()">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="toggle-group">
            <label>Upload Portrait (4:5)</label>
            <label class="toggle-switch">
              <input type="checkbox" id="galleryUploadPortrait" onchange="saveGalleryOptions()">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="toggle-group">
            <label>Upload Square (1:1)</label>
            <label class="toggle-switch">
              <input type="checkbox" id="galleryUploadSquare" onchange="saveGalleryOptions()">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="toggle-group">
            <label>Upload Transparent PNGs</label>
            <label class="toggle-switch">
              <input type="checkbox" id="galleryUploadTransparent" onchange="saveGalleryOptions()">
              <span class="toggle-slider"></span>
            </label>
          </div>

          <!-- Upload Stats -->
          <div class="upload-stats">
            <div class="upload-stat success">
              <div class="value" id="galleryUploadSuccess">0</div>
              <div>Uploaded</div>
            </div>
            <div class="upload-stat failed">
              <div class="value" id="galleryUploadFailed">0</div>
              <div>Failed</div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeGalleryModal()">Close</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Update Banner -->
  <div class="update-banner" id="updateBanner">
    <span class="message" id="updateMessage">A new version is available!</span>
    <span class="version" id="updateVersion"></span>
    <div class="progress-bar" id="updateProgress" style="display: none;">
      <div class="fill" id="updateProgressFill"></div>
    </div>
    <button class="btn-update" id="updateBtn" onclick="handleUpdateAction()">Download</button>
    <button class="btn-dismiss" onclick="dismissUpdate()">Later</button>
  </div>

  <div class="version-display" id="versionDisplay"></div>

  <script>
    const { ipcRenderer } = require('electron');
    const path = require('path');
    
    let currentPerson = null;
    let isSessionActive = false;
    let sessionPhotoCount = 0;
    let recentSessions = [];
    let currentPersonFolder = '';
    let currentShootNumber = '';
    
    async function init() {
      const settings = await ipcRenderer.invoke('get-settings');
      updateFolderStatus(settings);
    }
    
    function updateFolderStatus(settings) {
      const watchEl = document.getElementById('watchFolderStatus');
      const outputEl = document.getElementById('outputFolderStatus');
      
      if (settings.watchFolder) {
        watchEl.textContent = settings.watchFolder;
        watchEl.className = 'value set';
      } else {
        watchEl.textContent = 'Click to set...';
        watchEl.className = 'value not-set';
      }
      
      if (settings.outputFolder) {
        outputEl.textContent = settings.outputFolder;
        outputEl.className = 'value set';
      } else {
        outputEl.textContent = 'Click to set...';
        outputEl.className = 'value not-set';
      }
      
      checkStartButton();
    }
    
    async function selectWatchFolder() {
      const folder = await ipcRenderer.invoke('select-watch-folder');
      if (folder) {
        document.getElementById('watchFolderStatus').textContent = folder;
        document.getElementById('watchFolderStatus').className = 'value set';
        checkStartButton();
        showToast('Watch folder set!');
      }
    }
    
    async function selectOutputFolder() {
      const folder = await ipcRenderer.invoke('select-output-folder');
      if (folder) {
        document.getElementById('outputFolderStatus').textContent = folder;
        document.getElementById('outputFolderStatus').className = 'value set';
        checkStartButton();
        showToast('Output folder set!');
      }
    }
    
    function checkStartButton() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const email = document.getElementById('email').value.trim();
      const watchSet = document.getElementById('watchFolderStatus').classList.contains('set');
      const outputSet = document.getElementById('outputFolderStatus').classList.contains('set');
      
      document.getElementById('startBtn').disabled = !(firstName && lastName && email && watchSet && outputSet);
    }
    
    async function startSession() {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const email = document.getElementById('email').value.trim();
      const mobile = document.getElementById('mobile').value.trim();
      const company = document.getElementById('company').value.trim();

      // Get shoot number from main process
      const result = await ipcRenderer.invoke('start-session', {
        firstName, lastName, email, mobile, company
      });

      if (!result.success) {
        showToast('Error starting session: ' + result.error, true);
        return;
      }

      currentShootNumber = result.shootNumber;
      currentPerson = { firstName, lastName, email, mobile, company, shootNumber: currentShootNumber };
      isSessionActive = true;
      sessionPhotoCount = 0;
      currentPersonFolder = '';

      document.getElementById('formFields').style.display = 'none';
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('endBtn').style.display = 'block';
      document.getElementById('photoCounter').style.display = 'block';
      document.getElementById('photoCount').textContent = '0';

      document.getElementById('activeSession').style.display = 'block';
      document.getElementById('activeSessionName').textContent = `${currentShootNumber} - ${firstName} ${lastName}`;

      showToast(`Session ${currentShootNumber} started for ${firstName} ${lastName}`);
    }
    
    function endSession() {
      if (currentPerson && sessionPhotoCount > 0) {
        recentSessions.unshift({
          ...currentPerson,
          timestamp: new Date(),
          photoCount: sessionPhotoCount,
          folder: currentPersonFolder
        });
        updateRecentList();
      }
      
      currentPerson = null;
      isSessionActive = false;
      sessionPhotoCount = 0;
      currentPersonFolder = '';
      currentShootNumber = '';
      
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('email').value = '';
      document.getElementById('mobile').value = '';
      document.getElementById('company').value = '';
      
      document.getElementById('formFields').style.display = 'block';
      document.getElementById('startBtn').style.display = 'block';
      document.getElementById('endBtn').style.display = 'none';
      document.getElementById('photoCounter').style.display = 'none';
      document.getElementById('activeSession').style.display = 'none';
      
      document.getElementById('previewArea').innerHTML = `
        <div class="placeholder">
          <div class="icon">ðŸ“·</div>
          <p>Waiting for image...</p>
          <p style="font-size: 0.85em; margin-top: 5px;">Take a photo in LUMIX Tether</p>
        </div>
      `;
      
      document.getElementById('firstName').focus();
      checkStartButton();
      showToast('Session ended. Ready for next person!');
    }
    
    // Listen for new images
    ipcRenderer.on('new-image', async (event, filePath) => {
      console.log('New image detected:', filePath);

      const ext = path.extname(filePath).toLowerCase();
      const isJpeg = ['.jpg', '.jpeg'].includes(ext);
      const isRaw = ['.rw2', '.raw', '.arw', '.cr2', '.cr3', '.nef', '.orf', '.dng'].includes(ext);

      // Only show preview for JPEGs
      if (isJpeg) {
        const previewArea = document.getElementById('previewArea');
        previewArea.innerHTML = `<img src="file://${filePath}?t=${Date.now()}" alt="Preview">`;
      }

      // If session is active, save only RAW files (JPEGs are just for preview)
      if (isSessionActive && currentPerson && isRaw) {
        const result = await ipcRenderer.invoke('save-session', {
          ...currentPerson,
          originalFile: filePath
        });

        if (result.success) {
          sessionPhotoCount++;
          currentPersonFolder = result.personFolder;
          document.getElementById('photoCount').textContent = sessionPhotoCount;
          showToast(`Photo ${sessionPhotoCount} saved for ${currentPerson.firstName}`);
        } else {
          showToast('Error saving: ' + result.error, true);
        }
      } else if (!isSessionActive && isRaw) {
        showToast('Start a session first to save photos', true);
      }
    });
    
    function updateRecentList() {
      const list = document.getElementById('recentList');
      
      if (recentSessions.length === 0) {
        list.innerHTML = '<div class="empty-state">No sessions yet today</div>';
        return;
      }
      
      list.innerHTML = recentSessions.slice(0, 10).map(s => `
        <div class="session-item" onclick="openFolder('${s.folder.replace(/'/g, "\\'")}')">
          <div>
            <div class="name">${s.firstName} ${s.lastName}</div>
            <div class="email">${s.email}</div>
          </div>
          <div class="count">${s.photoCount} photo(s)</div>
        </div>
      `).join('');
    }
    
    function openFolder(folderPath) {
      if (folderPath) {
        ipcRenderer.invoke('open-folder', folderPath);
      }
    }
    
    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // Form listeners
    document.querySelectorAll('#formFields input').forEach(input => {
      input.addEventListener('input', checkStartButton);
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !document.getElementById('startBtn').disabled && !isSessionActive) {
        startSession();
      }
      if (e.key === 'Escape' && isSessionActive) {
        endSession();
      }
    });
    
    // Auto-update handling
    let updateState = 'idle'; // idle, available, downloading, downloaded

    ipcRenderer.on('update-status', (event, data) => {
      const banner = document.getElementById('updateBanner');
      const message = document.getElementById('updateMessage');
      const version = document.getElementById('updateVersion');
      const btn = document.getElementById('updateBtn');
      const progress = document.getElementById('updateProgress');
      const progressFill = document.getElementById('updateProgressFill');

      switch (data.status) {
        case 'available':
          updateState = 'available';
          message.textContent = 'A new version is available!';
          version.textContent = `v${data.version}`;
          version.style.display = 'inline';
          btn.textContent = 'Download';
          btn.style.display = 'inline-block';
          progress.style.display = 'none';
          banner.classList.add('show');
          break;

        case 'downloading':
          updateState = 'downloading';
          message.textContent = 'Downloading update...';
          btn.style.display = 'none';
          progress.style.display = 'block';
          progressFill.style.width = `${data.percent}%`;
          break;

        case 'downloaded':
          updateState = 'downloaded';
          message.textContent = 'Update ready to install!';
          version.textContent = `v${data.version}`;
          btn.textContent = 'Restart Now';
          btn.style.display = 'inline-block';
          progress.style.display = 'none';
          break;

        case 'error':
          banner.classList.remove('show');
          showToast('Update check failed: ' + data.error, true);
          break;

        case 'not-available':
          // Silently ignore - no update available
          break;
      }
    });

    function handleUpdateAction() {
      if (updateState === 'available') {
        ipcRenderer.invoke('download-update');
      } else if (updateState === 'downloaded') {
        ipcRenderer.invoke('install-update');
      }
    }

    function dismissUpdate() {
      document.getElementById('updateBanner').classList.remove('show');
    }

    // Display app version
    async function displayVersion() {
      const version = await ipcRenderer.invoke('get-app-version');
      document.getElementById('versionDisplay').textContent = `v${version}`;
    }

    displayVersion();
    init();

    // AI Processing UI Functions

    let aiSettings = {
      hasApiKey: false,
      processingEnabled: true,
      autoProcessOnCapture: true,
      outputPortrait: true,
      outputSquare: true,
      faceEnhancement: 'medium',
      skinSmoothing: 'off',
      shineRemoval: 'off',
      upscaling: 'off',
      backgroundRemoval: true,
      backgroundColor: ''
    };

    let queueStatus = {
      pending: 0,
      processing: 0,
      failed: 0,
      completed: 0
    };

    // Initialize AI settings on load
    async function initAISettings() {
      try {
        aiSettings = await ipcRenderer.invoke('get-ai-settings');
        updateProcessingIndicator();
        updateSettingsUI();

        // Get initial queue status
        const status = await ipcRenderer.invoke('get-queue-status');
        updateQueueUI(status);
      } catch (err) {
        console.error('Error loading AI settings:', err);
      }
    }

    // Listen for processing status updates
    ipcRenderer.on('processing-status', (event, status) => {
      updateQueueUI(status);
      updateProcessingIndicator(status);
    });

    function updateProcessingIndicator(status) {
      const dot = document.getElementById('processingDot');
      const text = document.getElementById('processingText');

      if (!aiSettings.hasApiKey) {
        dot.className = 'dot disabled';
        text.textContent = 'AI Processing: Setup Required';
        return;
      }

      if (!aiSettings.processingEnabled) {
        dot.className = 'dot disabled';
        text.textContent = 'AI Processing: Disabled';
        return;
      }

      if (status && status.isProcessing) {
        dot.className = 'dot active';
        text.textContent = `Processing: ${status.pending + 1} remaining`;
      } else if (status && status.failed > 0) {
        dot.className = 'dot warning';
        text.textContent = `AI Processing: ${status.failed} failed`;
      } else if (status && status.pending > 0) {
        dot.className = 'dot active';
        text.textContent = `Queue: ${status.pending} pending`;
      } else {
        dot.className = 'dot active';
        text.textContent = 'AI Processing: Ready';
      }
    }

    function updateQueueUI(status) {
      queueStatus = status;

      document.getElementById('queuePending').textContent = status.pending || 0;
      document.getElementById('queueProcessing').textContent = status.processing || 0;
      document.getElementById('queueFailed').textContent = status.failed || 0;
      document.getElementById('queueCompleted').textContent = status.completed || 0;

      document.getElementById('retryFailedBtn').disabled = !status.failed;
      document.getElementById('clearCompletedBtn').disabled = !status.completed;
      document.getElementById('stopProcessingBtn').disabled = !status.isProcessing;
      document.getElementById('clearQueueBtn').disabled = !(status.pending || status.failed);
    }

    function updateSettingsUI() {
      document.getElementById('processingEnabled').checked = aiSettings.processingEnabled;
      document.getElementById('autoProcessEnabled').checked = aiSettings.autoProcessOnCapture;
      document.getElementById('outputPortrait').checked = aiSettings.outputPortrait;
      document.getElementById('outputSquare').checked = aiSettings.outputSquare;

      // Enhancement dropdowns
      document.getElementById('faceEnhancement').value = aiSettings.faceEnhancement || 'medium';
      document.getElementById('skinSmoothing').value = aiSettings.skinSmoothing || 'off';
      document.getElementById('shineRemoval').value = aiSettings.shineRemoval || 'off';
      document.getElementById('upscaling').value = aiSettings.upscaling || 'off';

      // Background options
      document.getElementById('backgroundRemoval').checked = aiSettings.backgroundRemoval !== false;
      document.getElementById('backgroundColor').value = aiSettings.backgroundColor || '';
      document.getElementById('bgColorPicker').value = aiSettings.backgroundColor || '#FFFFFF';
    }

    async function saveEnhancementOptions() {
      const options = {
        outputPortrait: document.getElementById('outputPortrait').checked,
        outputSquare: document.getElementById('outputSquare').checked,
        faceEnhancement: document.getElementById('faceEnhancement').value,
        skinSmoothing: document.getElementById('skinSmoothing').value,
        shineRemoval: document.getElementById('shineRemoval').value,
        upscaling: document.getElementById('upscaling').value,
        backgroundRemoval: document.getElementById('backgroundRemoval').checked,
        backgroundColor: document.getElementById('backgroundColor').value.trim()
      };

      // Validate at least one output format is selected
      if (!options.outputPortrait && !options.outputSquare) {
        showToast('Please select at least one output format', true);
        // Revert to previous values
        updateSettingsUI();
        return;
      }

      await ipcRenderer.invoke('set-ai-settings', options);
      Object.assign(aiSettings, options);
      showToast('Enhancement options saved');
    }

    function updateBgColor() {
      const colorPicker = document.getElementById('bgColorPicker');
      const colorText = document.getElementById('backgroundColor');
      colorText.value = colorPicker.value;
      saveEnhancementOptions();
    }

    function openSettingsModal() {
      document.getElementById('settingsModal').classList.add('show');
      document.getElementById('connectionStatus').innerHTML = '';
      // Don't show the saved API key for security
      document.getElementById('apiKeyInput').value = '';
      document.getElementById('apiKeyInput').placeholder = aiSettings.hasApiKey ? 'API key saved (enter new to replace)' : 'r8_xxxxxxxxxxxx';
    }

    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    async function toggleProcessing() {
      const enabled = document.getElementById('processingEnabled').checked;
      await ipcRenderer.invoke('set-ai-settings', { processingEnabled: enabled });
      aiSettings.processingEnabled = enabled;
      updateProcessingIndicator(queueStatus);
    }

    async function toggleAutoProcess() {
      const enabled = document.getElementById('autoProcessEnabled').checked;
      await ipcRenderer.invoke('set-ai-settings', { autoProcessOnCapture: enabled });
      aiSettings.autoProcessOnCapture = enabled;
    }

    async function testAndSaveApiKey() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      const statusEl = document.getElementById('connectionStatus');

      if (!apiKey && !aiSettings.hasApiKey) {
        statusEl.innerHTML = '<div class="status-message error">Please enter an API key</div>';
        return;
      }

      // If no new key entered but we have one saved, just close
      if (!apiKey && aiSettings.hasApiKey) {
        closeSettingsModal();
        return;
      }

      statusEl.innerHTML = '<div class="status-message info">Testing connection...</div>';

      try {
        const result = await ipcRenderer.invoke('test-api-connection', apiKey);

        if (result.success) {
          // Save the API key
          await ipcRenderer.invoke('set-ai-settings', { replicateApiKey: apiKey });
          aiSettings.hasApiKey = true;
          statusEl.innerHTML = '<div class="status-message success">Connected successfully! Settings saved.</div>';
          updateProcessingIndicator(queueStatus);

          setTimeout(() => closeSettingsModal(), 1500);
        } else {
          statusEl.innerHTML = `<div class="status-message error">Connection failed: ${result.error}</div>`;
        }
      } catch (err) {
        statusEl.innerHTML = `<div class="status-message error">Error: ${err.message}</div>`;
      }
    }

    async function retryFailed() {
      await ipcRenderer.invoke('retry-failed');
      showToast('Retrying failed items...');
    }

    async function clearCompleted() {
      await ipcRenderer.invoke('clear-completed');
      showToast('Cleared completed items');
    }

    async function stopProcessing() {
      const result = await ipcRenderer.invoke('stop-processing');
      if (result.success) {
        showToast(result.message);
      } else {
        showToast('Error: ' + result.error, true);
      }
    }

    async function clearQueue() {
      // Ask if they want to clear failed items too
      const hasFailed = queueStatus.failed > 0;
      const hasPending = queueStatus.pending > 0;

      let clearFailed = false;
      if (hasFailed && hasPending) {
        clearFailed = confirm('Also clear failed items?\n\nClick OK to clear pending AND failed items.\nClick Cancel to clear only pending items.');
      } else if (hasFailed && !hasPending) {
        clearFailed = true; // Only failed items exist
      }

      const result = await ipcRenderer.invoke('clear-queue', clearFailed);
      if (result.success) {
        const msg = [];
        if (result.clearedPending > 0) msg.push(`${result.clearedPending} pending`);
        if (result.clearedFailed > 0) msg.push(`${result.clearedFailed} failed`);
        showToast(`Cleared ${msg.join(' and ')} item(s)`);
      } else {
        showToast('Error: ' + result.error, true);
      }
    }

    function openExternal(url) {
      require('electron').shell.openExternal(url);
    }

    // Close modal on escape or clicking outside
    document.getElementById('settingsModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closeSettingsModal();
      }
    });

    document.getElementById('reprocessModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closeReprocessModal();
      }
    });

    // Reprocess Modal Functions
    async function openReprocessModal() {
      document.getElementById('reprocessModal').classList.add('show');
      document.getElementById('sessionFolderList').innerHTML = '<div class="empty-state">Loading sessions...</div>';

      try {
        const folders = await ipcRenderer.invoke('get-session-folders');

        if (folders.length === 0) {
          document.getElementById('sessionFolderList').innerHTML = '<div class="empty-state">No session folders found</div>';
          return;
        }

        document.getElementById('sessionFolderList').innerHTML = folders.map(f => `
          <div class="session-folder-item">
            <div class="info">
              <div class="name">${f.shootNumber} - ${f.personName}</div>
              <div class="details">${f.rawCount} photo(s) | ${f.processedCount} processed</div>
            </div>
            <span class="status-badge ${f.needsProcessing ? 'needs-processing' : 'processed'}">
              ${f.needsProcessing ? 'Needs Processing' : 'Processed'}
            </span>
            <button class="btn-reprocess" onclick="reprocessFolder('${f.path.replace(/'/g, "\\'")}')">
              ${f.needsProcessing ? 'Process' : 'Reprocess'}
            </button>
          </div>
        `).join('');
      } catch (err) {
        document.getElementById('sessionFolderList').innerHTML = `<div class="empty-state">Error loading folders: ${err.message}</div>`;
      }
    }

    function closeReprocessModal() {
      document.getElementById('reprocessModal').classList.remove('show');
    }

    async function reprocessFolder(folderPath) {
      try {
        const result = await ipcRenderer.invoke('reprocess-folder', folderPath);

        if (result.success) {
          showToast(result.message);
          if (result.queued > 0) {
            closeReprocessModal();
          } else {
            // Refresh the list to show updated status
            openReprocessModal();
          }
        } else {
          showToast('Error: ' + result.error, true);
        }
      } catch (err) {
        showToast('Error: ' + err.message, true);
      }
    }

    async function selectCustomFolder() {
      try {
        const folderPath = await ipcRenderer.invoke('select-folder-to-reprocess');
        if (folderPath) {
          await reprocessFolder(folderPath);
        }
      } catch (err) {
        showToast('Error: ' + err.message, true);
      }
    }

    async function reprocessAllFolders() {
      const btn = document.getElementById('reprocessAllBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        const result = await ipcRenderer.invoke('reprocess-all-folders');

        if (result.success) {
          showToast(`Added ${result.totalQueued} photo(s) from ${result.foldersProcessed} folder(s) to queue`);
          closeReprocessModal();
        } else {
          showToast('Error: ' + result.error, true);
        }
      } catch (err) {
        showToast('Error: ' + err.message, true);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Reprocess All';
      }
    }

    // Failed items display
    async function toggleFailedDetails() {
      const section = document.getElementById('failedItemsSection');
      if (section.style.display === 'none') {
        await loadFailedItems();
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    }

    async function loadFailedItems() {
      try {
        const items = await ipcRenderer.invoke('get-failed-items');
        const list = document.getElementById('failedItemsList');

        if (items.length === 0) {
          list.innerHTML = '<div style="color: #888;">No failed items</div>';
          return;
        }

        list.innerHTML = items.map(item => `
          <div class="failed-item">
            <div class="name">${item.baseName || item.shootNumber}</div>
            <div class="error">${item.error || 'Unknown error'}</div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error loading failed items:', err);
      }
    }

    // Processing Log Functions
    const maxLogEntries = 100;

    function addLogEntry(message, type = 'info') {
      const log = document.getElementById('processingLog');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">${time}</span><span class="log-${type}">${message}</span>`;
      log.appendChild(entry);

      // Keep only last N entries
      while (log.children.length > maxLogEntries) {
        log.removeChild(log.firstChild);
      }

      // Auto-scroll to bottom
      log.scrollTop = log.scrollHeight;
    }

    function clearProcessingLog() {
      document.getElementById('processingLog').innerHTML = '';
      addLogEntry('Log cleared', 'info');
    }

    // Listen for log messages from main process
    ipcRenderer.on('processing-log', (event, data) => {
      addLogEntry(data.message, data.type || 'info');
    });

    // Initialize AI settings
    initAISettings();

    // ============================================
    // Gallery Functions
    // ============================================

    let gallerySettings = {
      isAuthenticated: false,
      autoUpload: false,
      uploadPortrait: true,
      uploadSquare: true,
      uploadTransparent: true,
      selectedGalleryId: null,
      selectedGalleryName: null
    };

    let galleryUploadStats = { success: 0, failed: 0 };

    // Initialize gallery settings on load
    async function initGallerySettings() {
      try {
        const settings = await ipcRenderer.invoke('get-gallery-settings');
        gallerySettings = { ...gallerySettings, ...settings };
        updateGalleryUI();
      } catch (err) {
        console.error('Error loading gallery settings:', err);
      }
    }

    function updateGalleryUI() {
      // Update gallery indicator
      const indicator = document.getElementById('galleryIndicator');
      if (gallerySettings.selectedGalleryId && gallerySettings.autoUpload) {
        indicator.style.display = 'flex';
        document.getElementById('selectedGalleryName').textContent = gallerySettings.selectedGalleryName || 'Selected Gallery';
      } else {
        indicator.style.display = 'none';
      }

      // Update modal UI
      document.getElementById('galleryAutoUpload').checked = gallerySettings.autoUpload;
      document.getElementById('galleryUploadPortrait').checked = gallerySettings.uploadPortrait;
      document.getElementById('galleryUploadSquare').checked = gallerySettings.uploadSquare;
      document.getElementById('galleryUploadTransparent').checked = gallerySettings.uploadTransparent;

      // Update upload stats
      document.getElementById('galleryUploadSuccess').textContent = galleryUploadStats.success;
      document.getElementById('galleryUploadFailed').textContent = galleryUploadStats.failed;
    }

    async function openGalleryModal() {
      document.getElementById('galleryModal').classList.add('show');

      // Refresh settings
      const settings = await ipcRenderer.invoke('get-gallery-settings');
      gallerySettings = { ...gallerySettings, ...settings };

      if (settings.isAuthenticated || settings.hasCredentials) {
        // Try to test connection
        const testResult = await ipcRenderer.invoke('test-gallery-connection');
        if (testResult.success) {
          showGalleryAuthSection();
          loadGalleries();
        } else {
          showGalleryLoginSection();
        }
      } else {
        showGalleryLoginSection();
      }

      updateGalleryUI();
    }

    function closeGalleryModal() {
      document.getElementById('galleryModal').classList.remove('show');
    }

    function showGalleryLoginSection() {
      document.getElementById('galleryLoginSection').style.display = 'block';
      document.getElementById('galleryAuthSection').style.display = 'none';
    }

    function showGalleryAuthSection() {
      document.getElementById('galleryLoginSection').style.display = 'none';
      document.getElementById('galleryAuthSection').style.display = 'block';
    }

    async function loginToGallery() {
      const username = document.getElementById('galleryUsername').value.trim();
      const password = document.getElementById('galleryPassword').value;
      const statusEl = document.getElementById('galleryLoginStatus');

      if (!username || !password) {
        statusEl.innerHTML = '<div class="status-message error">Please enter username and password</div>';
        return;
      }

      statusEl.innerHTML = '<div class="status-message info">Connecting...</div>';

      try {
        const result = await ipcRenderer.invoke('set-gallery-credentials', { username, password });

        if (result.success) {
          statusEl.innerHTML = '<div class="status-message success">Connected successfully!</div>';
          gallerySettings.isAuthenticated = true;

          setTimeout(() => {
            showGalleryAuthSection();
            loadGalleries();
          }, 1000);
        } else {
          statusEl.innerHTML = `<div class="status-message error">${result.error}</div>`;
        }
      } catch (err) {
        statusEl.innerHTML = `<div class="status-message error">Error: ${err.message}</div>`;
      }
    }

    async function logoutFromGallery() {
      await ipcRenderer.invoke('gallery-logout');
      gallerySettings.isAuthenticated = false;
      gallerySettings.selectedGalleryId = null;
      gallerySettings.selectedGalleryName = null;
      document.getElementById('galleryUsername').value = '';
      document.getElementById('galleryPassword').value = '';
      showGalleryLoginSection();
      updateGalleryUI();
      showToast('Logged out from gallery');
    }

    async function loadGalleries() {
      const listEl = document.getElementById('galleryList');
      listEl.innerHTML = '<div class="empty-state">Loading galleries...</div>';

      try {
        const result = await ipcRenderer.invoke('list-galleries');

        if (!result.success) {
          listEl.innerHTML = `<div class="empty-state">Error: ${result.error}</div>`;
          return;
        }

        if (!result.galleries || result.galleries.length === 0) {
          listEl.innerHTML = '<div class="empty-state">No galleries found. Create one below.</div>';
          return;
        }

        listEl.innerHTML = result.galleries.map(g => {
          const isSelected = gallerySettings.selectedGalleryId === (g.id || g._id);
          const photoCount = g.photo_count || g.photos?.length || 0;
          const createdDate = g.created_at ? new Date(g.created_at).toLocaleDateString() : '';

          return `
            <div class="gallery-item ${isSelected ? 'selected' : ''}" onclick="selectGallery('${g.id || g._id}', '${(g.name || '').replace(/'/g, "\\'")}')">
              <div class="gallery-info">
                <div class="gallery-title">${g.name || 'Untitled Gallery'}</div>
                <div class="gallery-meta">${photoCount} photos${createdDate ? ' â€¢ Created ' + createdDate : ''}</div>
              </div>
              ${isSelected ? '<span style="color: #51cf66;">âœ“ Selected</span>' : '<button class="btn-select">Select</button>'}
            </div>
          `;
        }).join('');
      } catch (err) {
        listEl.innerHTML = `<div class="empty-state">Error: ${err.message}</div>`;
      }
    }

    async function selectGallery(galleryId, galleryName) {
      try {
        const result = await ipcRenderer.invoke('set-selected-gallery', { galleryId, galleryName });

        if (result.success) {
          gallerySettings.selectedGalleryId = galleryId;
          gallerySettings.selectedGalleryName = galleryName;
          updateGalleryUI();
          loadGalleries(); // Refresh to show selection
          showToast(`Gallery "${galleryName}" selected`);
        }
      } catch (err) {
        showToast('Error selecting gallery: ' + err.message, true);
      }
    }

    async function clearGallerySelection() {
      await ipcRenderer.invoke('clear-gallery-selection');
      gallerySettings.selectedGalleryId = null;
      gallerySettings.selectedGalleryName = null;
      updateGalleryUI();
      showToast('Gallery selection cleared');
    }

    async function createNewGallery() {
      const name = document.getElementById('newGalleryName').value.trim();

      if (!name) {
        showToast('Please enter a gallery name', true);
        return;
      }

      try {
        const result = await ipcRenderer.invoke('create-gallery', { name });

        if (result.success) {
          document.getElementById('newGalleryName').value = '';
          showToast(`Gallery "${name}" created`);
          loadGalleries();

          // Auto-select the new gallery
          const newGallery = result.gallery;
          if (newGallery && (newGallery.id || newGallery._id)) {
            await selectGallery(newGallery.id || newGallery._id, name);
          }
        } else {
          showToast('Error: ' + result.error, true);
        }
      } catch (err) {
        showToast('Error creating gallery: ' + err.message, true);
      }
    }

    async function saveGalleryOptions() {
      const options = {
        autoUpload: document.getElementById('galleryAutoUpload').checked,
        uploadPortrait: document.getElementById('galleryUploadPortrait').checked,
        uploadSquare: document.getElementById('galleryUploadSquare').checked,
        uploadTransparent: document.getElementById('galleryUploadTransparent').checked
      };

      // Require at least one file type
      if (!options.uploadPortrait && !options.uploadSquare && !options.uploadTransparent) {
        showToast('Please select at least one file type to upload', true);
        document.getElementById('galleryUploadPortrait').checked = true;
        return;
      }

      await ipcRenderer.invoke('set-gallery-upload-options', options);
      gallerySettings = { ...gallerySettings, ...options };
      updateGalleryUI();
    }

    // Listen for gallery upload results
    ipcRenderer.on('gallery-upload-result', (event, data) => {
      if (data.success) {
        galleryUploadStats.success++;
        addLogEntry(`Uploaded to gallery: ${data.filename}`, 'success');
      } else {
        galleryUploadStats.failed++;
        addLogEntry(`Gallery upload failed: ${data.filename} - ${data.error}`, 'error');
      }
      updateGalleryUI();
    });

    // Listen for processing item complete
    ipcRenderer.on('processing-item-complete', (event, data) => {
      // This event is fired when a photo finishes processing
      // Gallery upload is handled automatically in main process
    });

    // Close modal on escape or clicking outside
    document.getElementById('galleryModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        closeGalleryModal();
      }
    });

    // Initialize gallery settings
    initGallerySettings();
  </script>
</body>
</html>
